<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardi√£o - Acesso</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- √çcones (Lucide) - Carregamento com defer para n√£o bloquear -->
    <script src="https://unpkg.com/lucide@latest" defer></script>
    
    <!-- Carrega a configura√ß√£o da base da API (Opcional, pois temos fallback no c√≥digo) -->
    <script src="apisistema.js"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F27A23; }
        
        .outline-text { color: transparent; -webkit-text-stroke: 2px rgba(255, 255, 255, 0.5); font-weight: 900; line-height: 1; }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeInUp 0.4s ease-out forwards; }
        
        /* Chat Styles */
        .chat-bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 18px;
            margin-bottom: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: fadeInUp 0.3s ease-out;
            position: relative;
        }
        .chat-bot { background-color: #ffffff; color: #374151; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #f3f4f6; }
        .chat-user { background-color: #FDBA74; color: #7c2d12; align-self: flex-end; border-bottom-right-radius: 2px; font-weight: 600; text-align: right; box-shadow: 0 2px 8px rgba(249, 115, 22, 0.2); }
        
        .chat-container::-webkit-scrollbar { width: 4px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 10px; }
        
        .hidden-view { display: none !important; }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden relative bg-[#F27A23]">

    <!-- FUNDO DECORATIVO -->
    <div class="pointer-events-none select-none absolute inset-0 z-0">
        <div class="absolute left-0 bottom-0 h-full flex items-center justify-center w-20">
            <h1 class="outline-text text-[15vh] md:text-[20vh] tracking-widest transform -rotate-90 whitespace-nowrap origin-center opacity-60">GUARDI√ÉO</h1>
        </div>
        <div class="absolute bottom-[-5%] right-0 w-full flex justify-end pr-4 md:pr-10">
            <h1 class="outline-text text-[18vh] md:text-[25vh] tracking-tighter opacity-60 translate-y-4">I√ÉO</h1>
        </div>
        <div class="absolute top-0 right-0 h-full w-1/2 overflow-hidden">
             <svg viewBox="0 0 200 400" preserveAspectRatio="none" class="h-full w-full text-white opacity-90 float-right">
                <path fill="currentColor" d="M150,0 C150,0 80,100 120,200 C160,300 50,400 50,400 L200,400 L200,0 Z" transform="translate(50,0) scale(1.5, 1)"/>
            </svg>
        </div>
    </div>

    <!-- √ÅREA PRINCIPAL -->
    <div class="relative z-10 w-full h-full flex flex-col items-center justify-center px-4 md:px-8">
        
        <!-- LOGO -->
        <div class="mb-4 flex justify-center transition-all duration-500 relative z-20" id="logoContainer">
            <img src="logo.sem.png" alt="Logo Guardi√£o" class="w-24 md:w-28 drop-shadow-lg">
        </div>

        <!-- CARD PRINCIPAL -->
        <div class="w-full max-w-md bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl border border-white/50 relative overflow-hidden transition-all duration-500 ease-in-out flex flex-col" id="mainCard" style="min-height: 420px; max-height: 85vh;">
            
            <!-- VIEW 1: LOGIN -->
            <div id="viewLogin" class="animate-fade-in flex flex-col justify-center p-8 h-full">
                <div class="text-center mb-8">
                    <h2 class="text-gray-800 text-2xl font-bold">Bem-vindo</h2>
                    <p class="text-gray-500 text-sm mt-1">Acesse sua conta para continuar</p>
                </div>
                
                <!-- Adicionado onsubmit="return false" como salvaguarda extra contra reload -->
                <form id="loginForm" class="space-y-5" novalidate>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="user" class="text-gray-400 w-5 h-5"></i></div>
                        <input type="text" id="loginCpf" name="loginCpf" placeholder="CPF ou CNPJ" maxlength="18" autocomplete="username" class="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:bg-white focus:ring-2 focus:ring-orange-400 outline-none transition-all font-medium">
                    </div>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="lock" class="text-gray-400 w-5 h-5"></i></div>
                        <input type="password" id="loginSenha" name="loginSenha" placeholder="Senha" autocomplete="current-password" class="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:bg-white focus:ring-2 focus:ring-orange-400 outline-none transition-all font-medium">
                    </div>
                    <button type="submit" id="btnLogin" class="w-full bg-gradient-to-r from-[#F27A23] to-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-xl active:scale-[0.98] transition-all uppercase tracking-wide text-sm mt-2">Entrar</button>
                </form>
                <div class="flex justify-between items-center mt-8 text-sm font-medium">
                    <button type="button" onclick="switchView('viewRecovery')" class="text-gray-500 hover:text-orange-600 transition-colors">Esqueci a senha</button>
                    <button type="button" onclick="startRegistration()" class="text-orange-600 hover:text-orange-700 bg-orange-50 px-4 py-1.5 rounded-full border border-orange-100 hover:bg-orange-100 transition-all">Criar Conta</button>
                </div>
            </div>

            <!-- VIEW 2: LOGGED IN -->
            <div id="viewLoggedIn" class="hidden-view animate-fade-in flex flex-col items-center justify-center p-8 h-full text-center">
                <div class="relative mb-6">
                    <div class="w-24 h-24 rounded-full border-4 border-orange-100 overflow-hidden shadow-xl bg-gray-100">
                        <img id="userAvatar" src="" alt="Foto Usu√°rio" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute bottom-1 right-1 bg-green-500 w-5 h-5 rounded-full border-2 border-white animate-pulse"></div>
                </div>
                <h3 class="text-gray-800 text-xl font-bold mb-1">Ol√°, <span id="userName" class="text-[#F27A23]">Usu√°rio</span>!</h3>
                <p class="text-gray-500 text-sm mb-8">√â bom te ver por aqui.</p>
                <button onclick="handleQuickLogin()" class="w-full bg-[#F27A23] text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-orange-600 active:scale-[0.98] transition-all mb-3">Continuar Acesso</button>
                <button onclick="logout()" class="text-gray-400 text-sm hover:text-gray-600 font-medium py-2">Entrar com outra conta</button>
            </div>

            <!-- VIEW 3: CHAT REGISTER -->
            <div id="viewRegister" class="hidden-view flex flex-col h-[550px] bg-gray-50">
                <div class="bg-white px-4 py-3 flex items-center justify-between border-b border-gray-100 shadow-sm z-10">
                    <button onclick="cancelRegistration()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full transition-colors"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <div class="flex flex-col items-center"><span class="text-gray-800 font-bold text-sm">Cadastro Guardi√£o</span><span class="text-[#F27A23] text-xs font-medium">Assistente Virtual</span></div>
                    <div class="w-9 h-9 rounded-full bg-orange-100 flex items-center justify-center text-[#F27A23]"><i data-lucide="bot" class="w-5 h-5"></i></div>
                </div>
                <div id="chatMessages" class="flex-1 overflow-y-auto chat-container flex flex-col p-4 space-y-2 bg-slate-50"></div>
                <div class="bg-white p-3 border-t border-gray-100 relative shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                    <div id="inputAreaText" class="flex gap-2 items-center">
                        <input type="text" id="chatInput" class="flex-1 bg-gray-100 text-gray-800 rounded-full px-5 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300 focus:bg-white transition-all shadow-inner" placeholder="Digite sua resposta..." autocomplete="off">
                        <button onclick="submitChat()" class="bg-[#F27A23] text-white p-3 rounded-full shadow-lg hover:bg-orange-600 active:scale-90 transition-all"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                    <div id="inputAreaOptions" class="hidden flex flex-col gap-2 w-full"></div>
                    <div id="inputAreaUpload" class="hidden flex justify-center py-2">
                         <label class="cursor-pointer bg-white text-[#F27A23] border-2 border-[#F27A23] px-6 py-3 rounded-full font-bold shadow-sm flex items-center gap-2 hover:bg-orange-50 w-full justify-center transition-all active:scale-95">
                            <i data-lucide="camera" class="w-5 h-5"></i> Tirar ou Escolher Foto
                            <input type="file" id="photoUpload" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                        </label>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: RECOVERY -->
            <div id="viewRecovery" class="hidden-view animate-fade-in flex flex-col justify-center p-8 h-full bg-white">
                <button onclick="switchView('viewLogin')" class="absolute top-6 left-6 text-gray-400 hover:text-gray-600"><i data-lucide="arrow-left"></i></button>
                <div class="text-center mb-6 mt-4">
                    <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-[#F27A23]"><i data-lucide="key-round" class="w-8 h-8"></i></div>
                    <h2 class="text-gray-800 text-2xl font-bold">Recuperar Senha</h2>
                    <p class="text-gray-500 text-sm mt-2 px-4">Informe seu nome completo para buscarmos seu cadastro.</p>
                </div>
                <form id="recoveryForm" class="space-y-4">
                    <div class="relative"><input type="text" id="recNome" placeholder="Nome Completo" class="block w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-300 outline-none transition-all text-gray-800 font-medium"></div>
                    <button type="submit" class="w-full bg-[#F27A23] text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 hover:bg-orange-600 transition-all">Enviar C√≥digo</button>
                </form>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-2xl text-white font-semibold text-sm z-50 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-2"></div>

    <script>
        // --- API HELPERS (Blindado contra falha de carregamento) ---
        async function apiRequest(endpoint, method = 'GET', body = null) {
            // URL FIXA DE FALLBACK GARANTIDA
            const fallbackUrl = "https://3005-ifjg6cargn3icag87vhwr-6eb715a0.manusvm.computer/api";
            
            // Tenta usar vari√°vel global (apisistema.js), sen√£o usa o fallback
            const baseUrl = (typeof API_BASE_URL !== 'undefined') ? API_BASE_URL : fallbackUrl;
            const url = `${baseUrl}${endpoint}`;
            
            const headers = { 'Content-Type': 'application/json' };
            const token = localStorage.getItem('guardiao_token');
            if (token) headers['Authorization'] = `Bearer ${token}`;
            
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || data.mensagem || `Erro ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.warn(`[API] Erro ao conectar em ${url}:`, error);
                // Retorna mock apenas se falhar conex√£o real
                return mockLocalResponse(endpoint, body);
            }
        }

        function mockLocalResponse(endpoint, body) {
            return new Promise(resolve => {
                setTimeout(() => {
                    if (endpoint === '/auth/login') {
                        // Mock de Login
                        if (body.cpf_cnpj === '00000000000') {
                            resolve({ success: false, message: 'Credenciais inv√°lidas' });
                        } else {
                            const mockBase64 = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRjI3QTIzIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGNpcmNsZSBjeD0iMTIiIGN5PSI4IiByPSI1Ii8+PHBhdGggZD0iTTMgMjFhOSA5IDAgMCAxIDktOWg0YTkgOSAwIDAgMSA5IDl2MSIvPjwvc3ZnPg==";
                            resolve({ 
                                success: true, 
                                message: "Login realizado com sucesso",
                                data: { token: 'mock_token', usuario: { id: 1, nome_completo: 'Usu√°rio Teste', email: 'teste@email.com', foto_perfil: mockBase64 } } 
                            });
                        }
                    } else if (endpoint === '/auth/register') {
                        resolve({ success: true, message: "Sucesso", data: { token: 'mock_new', usuario: { ...body } } });
                    } else {
                        resolve({ success: true, message: 'Sucesso' });
                    }
                }, 800);
            });
        }

        // --- APP LOGIC ---
        let registerState = { step: 0, data: {} };

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa√ß√£o Segura do Lucide
            try { if (window.lucide) window.lucide.createIcons(); } catch(e) { console.warn("√çcones falharam no load"); }
            
            // Inicializa√ß√£o Segura das M√°scaras e Auth
            try {
                checkAuth();
                setupMasks();
            } catch(e) { console.error("Erro na inicializa√ß√£o", e); }

            // Listener de Login - PROTEGER CONTRA DUPLICA√á√ÉO E ERROS
            const form = document.getElementById('loginForm');
            if(form) {
                // Remove listener anterior se houver (boa pr√°tica em SPAs)
                form.removeEventListener('submit', handleLoginSubmit);
                form.addEventListener('submit', handleLoginSubmit);
            }

            document.getElementById('recoveryForm').addEventListener('submit', handleRecoverySubmit);
            document.getElementById('chatInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') submitChat(); });
        });

        function switchView(viewId) {
            ['viewLogin', 'viewLoggedIn', 'viewRegister', 'viewRecovery'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden-view');
            });
            const target = document.getElementById(viewId);
            if(target) target.classList.remove('hidden-view');
            
            const card = document.getElementById('mainCard');
            if (viewId === 'viewRegister') { 
                card.style.height = '600px'; 
                card.classList.remove('bg-white/95'); 
                card.classList.add('bg-white'); 
            } else { 
                card.style.height = 'auto'; 
                card.classList.add('bg-white/95'); 
            }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            if(!toast) return;
            const icon = type === 'success' ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
            toast.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-2xl text-white font-semibold text-sm z-50 transition-all duration-300 flex items-center gap-2 ${type === 'success' ? 'bg-emerald-600' : 'bg-red-500'}`;
            toast.innerHTML = `${icon} ${msg}`;
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-[-20px]'), 3500);
        }

        function checkAuth() {
            const u = localStorage.getItem('guardiao_user');
            const t = localStorage.getItem('guardiao_token');
            if (u && t) {
                try {
                    const user = JSON.parse(u);
                    const avatarImg = document.getElementById('userAvatar');
                    if (user.foto_perfil && user.foto_perfil.startsWith('data:image')) {
                        avatarImg.src = user.foto_perfil;
                    } else {
                        avatarImg.src = `https://ui-avatars.com/api/?name=${user.nome_completo}&background=F27A23&color=fff`;
                    }
                    const name = user.nome_completo ? user.nome_completo.split(' ')[0] : 'Usu√°rio';
                    document.getElementById('userName').innerText = name;
                    switchView('viewLoggedIn');
                } catch(e) { logout(); }
            } else { switchView('viewLogin'); }
        }

        // --- CORRE√á√ÉO PRINCIPAL: LOGIN HANDLER ROBUSTO ---
        async function handleLoginSubmit(e) {
            // 1. IMPEDE O RELOAD IMEDIATAMENTE
            e.preventDefault();
            e.stopPropagation();

            try {
                const cpfInput = document.getElementById('loginCpf');
                const senhaInput = document.getElementById('loginSenha');
                const btn = document.getElementById('btnLogin');

                const c = cpfInput.value.replace(/\D/g, '');
                const s = senhaInput.value;

                if (!c || !s) return showToast('Preencha CPF e Senha', 'error');

                // Feedback Visual
                const originalText = btn.innerText;
                btn.innerText = 'Autenticando...';
                btn.disabled = true;

                // Chamada API
                const res = await apiRequest('/auth/login', 'POST', { cpf_cnpj: c, senha: s });

                // Restaura Bot√£o
                btn.innerText = originalText;
                btn.disabled = false;

                if (res.success) {
                    localStorage.setItem('guardiao_token', res.data.token);
                    localStorage.setItem('guardiao_user', JSON.stringify(res.data.usuario));
                    showToast('Login realizado com sucesso!', 'success');
                    
                    // Pequeno delay para UX antes de mudar a tela
                    setTimeout(() => checkAuth(), 500);
                } else {
                    showToast(res.message || 'Dados incorretos', 'error');
                }
            } catch (error) {
                console.error("Erro fatal no login:", error);
                showToast("Erro interno no aplicativo", 'error');
                // Garante que o bot√£o seja liberado em caso de erro de script
                const btn = document.getElementById('btnLogin');
                if(btn) { btn.innerText = 'Entrar'; btn.disabled = false; }
            }
            
            return false; // Retorno extra para impedir submit antigo
        }

        function handleQuickLogin() { window.location.href = 'facial.tokem.html'; }
        
        function logout() { 
            localStorage.removeItem('guardiao_token');
            localStorage.removeItem('guardiao_user');
            document.getElementById('loginForm').reset(); 
            switchView('viewLogin'); 
        }

        async function handleRecoverySubmit(e) {
            e.preventDefault(); const n = document.getElementById('recNome').value; if(!n) return;
            const res = await apiRequest('/auth/recuperar-senha', 'POST', { nome_completo: n });
            if(res.success) { showToast('C√≥digo enviado!', 'success'); setTimeout(() => switchView('viewLogin'), 3000); }
            else showToast(res.message || 'N√£o encontrado', 'error');
        }

        // --- CHAT LOGIC ---
        const chatFlow = [
            { field: 'nome_completo', msg: 'Ol√°! Sou o assistente do Guardi√£o. Vamos configurar sua conta. üòä<br>Primeiro, como devo te chamar? (<b>Nome Completo</b>)', type: 'text' },
            { field: 'tipo_acesso', msg: 'Qual perfil de acesso voc√™ precisa?', type: 'options', options: [{label: 'üßë‚Äçüßë Familiar', value:'familiar'}, {label: 'üë¥ Idoso', value:'idoso'}, {label: 'ü©∫ Cuidador', value:'cuidador'}, {label: 'üè• Profissional', value:'saude'}] },
            { field: 'cpf_cnpj', msg: 'Digite seu <b>CPF</b>.', type: 'text', mask: 'cpf' },
            { field: 'email', msg: 'Seu <b>E-mail</b>?', type: 'text', validate: v=>v.includes('@') },
            { field: 'celular', msg: 'Seu <b>WhatsApp</b>?', type: 'text', mask: 'phone' },
            { field: 'sexo', msg: 'G√™nero?', type: 'options', options: [{label:'Masculino', value:'Masculino'}, {label:'Feminino', value:'Feminino'}, {label:'Outro', value:'Outro'}] },
            { field: 'cep', msg: 'Informe seu <b>CEP</b>.', type: 'text', mask: 'cep' },
            { field: 'senha', msg: 'Crie uma <b>Senha</b> (min 6 d√≠gitos).', type: 'password' },
            { field: 'foto_base64', msg: 'Sua <b>Foto de Perfil</b> üì∏', type: 'upload' },
            { field: 'termos', msg: 'Aceita os <a href="pdf.termo.pdf" class="text-orange-600 font-bold underline">Termos de Uso</a>?', type: 'options', options: [{label:'‚úÖ Aceito', value:'true'}] }
        ];

        function startRegistration() { registerState = {step:0, data:{}}; document.getElementById('chatMessages').innerHTML=''; switchView('viewRegister'); addBotMsg(chatFlow[0].msg); setupInput(chatFlow[0]); }
        function cancelRegistration() { switchView('viewLogin'); }
        function addBotMsg(t) { const d=document.createElement('div'); d.className='chat-bubble chat-bot'; d.innerHTML=t; document.getElementById('chatMessages').appendChild(d); scrollChat(); }
        function addUserMsg(t) { const d=document.createElement('div'); d.className='chat-bubble chat-user'; d.innerHTML=t; document.getElementById('chatMessages').appendChild(d); scrollChat(); }
        function scrollChat() { const c=document.getElementById('chatMessages'); setTimeout(() => c.scrollTop = c.scrollHeight, 50); }

        function setupInput(cfg) {
            const txt=document.getElementById('inputAreaText'), opt=document.getElementById('inputAreaOptions'), upl=document.getElementById('inputAreaUpload'), inp=document.getElementById('chatInput');
            txt.classList.add('hidden'); opt.classList.add('hidden'); upl.classList.add('hidden'); opt.innerHTML=''; inp.value=''; inp.type=cfg.type==='password'?'password':'text';
            inp.oninput = null;

            if(cfg.type==='text'||cfg.type==='password') {
                txt.classList.remove('hidden'); inp.focus();
                if(cfg.mask==='cpf') setupCpfMask(inp); if(cfg.mask==='phone') setupPhoneMask(inp); if(cfg.mask==='cep') setupCepMask(inp);
            } else if(cfg.type==='options') {
                opt.classList.remove('hidden');
                cfg.options.forEach(o => { 
                    const b=document.createElement('button'); b.className='w-full bg-white border border-gray-200 text-gray-700 hover:bg-orange-50 hover:border-orange-300 font-semibold py-3 px-4 rounded-xl text-left shadow-sm mb-2 flex justify-between';
                    b.innerHTML=`<span>${o.label}</span> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>`; b.onclick=()=>processStep(o.value, o.label); opt.appendChild(b); 
                });
            } else if(cfg.type==='upload') { upl.classList.remove('hidden'); }
        }

        function submitChat() { const v=document.getElementById('chatInput').value.trim(); if(v) processStep(v,v); }
        function handlePhotoUpload(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{ addUserMsg(`<img src="${e.target.result}" class="w-24 h-24 rounded-full border-4 border-white shadow-md">`); processStep(e.target.result,'Foto definida',true); }; r.readAsDataURL(i.files[0]); } }

        async function processStep(val, display, skip=false) {
            const cfg = chatFlow[registerState.step];
            if(cfg.validate && !cfg.validate(val)) return addBotMsg('‚ö†Ô∏è Inv√°lido. Tente novamente.');
            if(cfg.field==='cpf_cnpj' && val.replace(/\D/g,'').length<11) return addBotMsg('‚ö†Ô∏è CPF inv√°lido.');

            if(cfg.field === 'cep') {
                const cep = val.replace(/\D/g, '');
                if(cep.length !== 8) return addBotMsg('‚ö†Ô∏è CEP deve ter 8 n√∫meros.');
                if(!skip) addUserMsg(display);
                addBotMsg('üîç Buscando endere√ßo...');
                try {
                    const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const addr = await r.json();
                    if(addr.erro) { addBotMsg('‚ö†Ô∏è CEP n√£o encontrado.'); return; }
                    registerState.data.rua = addr.logradouro; registerState.data.bairro = addr.bairro;
                    registerState.data.cidade = addr.localidade; registerState.data.estado = addr.uf;
                    addBotMsg(`‚úÖ Endere√ßo: ${addr.logradouro}, ${addr.bairro} - ${addr.localidade}/${addr.uf}`);
                } catch(e) { addBotMsg('‚ö†Ô∏è Erro no CEP. Seguindo...'); }
            } else {
                if(!skip) addUserMsg(display);
            }

            registerState.data[cfg.field] = val;
            registerState.step++;
            if(registerState.step < chatFlow.length) { setTimeout(()=> { addBotMsg(chatFlow[registerState.step].msg); setupInput(chatFlow[registerState.step]); }, 600); }
            else { addBotMsg('Criando conta...'); finishReg(); }
        }

        async function finishReg() {
            const d = { rua:'-', cidade:'-', estado:'UF', bairro:'-', latitude:0, longitude:0, ...registerState.data };
            d.cpf_cnpj=d.cpf_cnpj.replace(/\D/g,''); d.celular=d.celular.replace(/\D/g,'');
            const res = await apiRequest('/auth/register', 'POST', d);
            if(res.success) { 
                addBotMsg('üéâ Sucesso! Entrando...'); 
                localStorage.setItem('guardiao_token', res.data.token);
                localStorage.setItem('guardiao_user', JSON.stringify(res.data.usuario));
                setTimeout(()=>window.location.href='facial.tokem.html', 2000);
            } else { 
                addBotMsg('‚ùå Erro: ' + (res.message || res.mensagem)); 
                setTimeout(() => { addBotMsg('Reiniciando...'); setTimeout(startRegistration, 2000); }, 3000);
            }
        }

        function setupMasks() { 
            const i=document.getElementById('loginCpf'); 
            if(i) setupCpfMask(i); 
        }
        function setupCpfMask(i) { i.oninput=e=>{ let v=e.target.value.replace(/\D/g,''); if(v.length>11) v=v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,"$1.$2.$3/$4-$5"); else v=v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4"); e.target.value=v; } }
        function setupPhoneMask(i) { i.oninput=e=>{ let v=e.target.value.replace(/\D/g,''); v=v.replace(/^(\d{2})(\d{5})(\d{4})/,"($1) $2-$3"); e.target.value=v; } }
        function setupCepMask(i) { i.oninput=e=>{ let v=e.target.value.replace(/\D/g,''); v=v.replace(/^(\d{5})(\d{3})/,"$1-$2"); e.target.value=v; } }
    </script>
</body>
</html>