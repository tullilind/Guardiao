<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardi√£o - Acesso</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- √çcones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 1. Importando APENAS a vari√°vel API_BASE_URL -->
    <script src="apisistema.js"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F27A23; }
        .outline-text { color: transparent; -webkit-text-stroke: 2px rgba(255, 255, 255, 0.5); font-weight: 900; line-height: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 10px; font-size: 0.95rem; line-height: 1.4; animation: fadeIn 0.3s ease-out; }
        .chat-bot { background-color: #ffffff; color: #374151; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-user { background-color: #FDBA74; color: #7c2d12; align-self: flex-end; border-bottom-right-radius: 4px; font-weight: 500; text-align: right; }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.3); border-radius: 10px; }
        .hidden-view { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden relative bg-[#F27A23]">

    <!-- FUNDO DECORATIVO -->
    <div class="pointer-events-none select-none absolute inset-0 z-0">
        <div class="absolute left-0 bottom-0 h-full flex items-center justify-center w-20">
            <h1 class="outline-text text-[15vh] md:text-[20vh] tracking-widest transform -rotate-90 whitespace-nowrap origin-center opacity-60">GUARDI√ÉO</h1>
        </div>
        <div class="absolute bottom-[-5%] right-0 w-full flex justify-end pr-4 md:pr-10">
            <h1 class="outline-text text-[18vh] md:text-[25vh] tracking-tighter opacity-60 translate-y-4">I√ÉO</h1>
        </div>
        <div class="absolute top-0 right-0 h-full w-1/2 overflow-hidden">
             <svg viewBox="0 0 200 400" preserveAspectRatio="none" class="h-full w-full text-white opacity-90 float-right">
                <path fill="currentColor" d="M150,0 C150,0 80,100 120,200 C160,300 50,400 50,400 L200,400 L200,0 Z" transform="translate(50,0) scale(1.5, 1)"/>
            </svg>
        </div>
    </div>

    <!-- √ÅREA PRINCIPAL -->
    <div class="relative z-10 w-full h-full flex flex-col items-center justify-center px-4 md:px-8">
        <!-- LOGO -->
        <div class="mb-6 flex justify-center transition-all duration-500" id="logoContainer">
            <img src="logo.sem.png" alt="Logo Guardi√£o" class="w-24 md:w-32 drop-shadow-md">
        </div>

        <!-- CONTAINER VIEWS -->
        <div class="w-full max-w-md bg-white/10 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 relative overflow-hidden transition-all duration-300" id="mainCard" style="min-height: 400px;">
            
            <!-- VIEW 1: LOGIN -->
            <div id="viewLogin" class="animate-fade-in h-full flex flex-col justify-center">
                <h2 class="text-white text-2xl font-bold text-center mb-6">Bem-vindo</h2>
                <form id="loginForm" class="space-y-4">
                    <div class="relative group">
                        <i data-lucide="user" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i>
                        <input type="text" id="loginCpf" placeholder="CPF ou CNPJ" maxlength="18" class="w-full bg-white text-gray-700 rounded-lg py-3 px-10 outline-none focus:ring-2 focus:ring-orange-300 shadow-sm font-medium placeholder-gray-400">
                    </div>
                    <div class="relative group">
                        <i data-lucide="lock" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i>
                        <input type="password" id="loginSenha" placeholder="Senha" class="w-full bg-white text-gray-700 rounded-lg py-3 px-10 outline-none focus:ring-2 focus:ring-orange-300 shadow-sm font-medium placeholder-gray-400">
                    </div>
                    <button type="submit" class="w-full bg-white text-[#F27A23] font-bold py-3.5 rounded-lg shadow-lg hover:bg-gray-50 active:scale-95 transition-all uppercase tracking-wide text-sm mt-2">Entrar</button>
                </form>
                <div class="flex justify-between items-center mt-6 text-sm">
                    <button onclick="switchView('viewRecovery')" class="text-white underline hover:text-gray-200">Esqueci a senha</button>
                    <button onclick="startRegistration()" class="text-white font-bold hover:text-gray-200 bg-white/20 px-3 py-1 rounded-full">Criar Conta</button>
                </div>
            </div>

            <!-- VIEW 2: LOGGED IN -->
            <div id="viewLoggedIn" class="hidden-view animate-fade-in flex flex-col items-center justify-center h-full text-center py-4">
                <div class="relative mb-6">
                    <div class="w-28 h-28 rounded-full border-4 border-white overflow-hidden shadow-lg bg-gray-200">
                        <img id="userAvatar" src="" alt="Foto Usu√°rio" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute bottom-0 right-0 bg-green-500 w-6 h-6 rounded-full border-2 border-white"></div>
                </div>
                <h3 class="text-white text-xl font-medium mb-1">Ol√°, <span id="userName" class="font-bold">Usu√°rio</span>!</h3>
                <p class="text-white/80 text-sm mb-8">Bem-vindo de volta.</p>
                <button onclick="handleQuickLogin()" class="w-full bg-white text-[#F27A23] font-bold py-3.5 rounded-lg shadow-lg hover:bg-gray-50 active:scale-95 transition-all mb-4">Continuar como <span id="btnUserName">Usu√°rio</span></button>
                <button onclick="logout()" class="text-white text-sm hover:underline opacity-80 hover:opacity-100">Trocar de conta</button>
            </div>

            <!-- VIEW 3: CHAT REGISTER -->
            <div id="viewRegister" class="hidden-view flex flex-col h-[500px]">
                <div class="flex items-center justify-between border-b border-white/20 pb-2 mb-2">
                    <button onclick="cancelRegistration()" class="text-white hover:bg-white/20 p-1 rounded-full"><i data-lucide="arrow-left"></i></button>
                    <span class="text-white font-bold text-sm">Cadastro Guardi√£o</span>
                    <div class="w-6"></div>
                </div>
                <div id="chatMessages" class="flex-1 overflow-y-auto chat-container flex flex-col p-2 space-y-3"></div>
                <div class="mt-2 pt-2 border-t border-white/20 relative">
                    <div id="inputAreaText" class="flex gap-2">
                        <input type="text" id="chatInput" class="flex-1 rounded-full px-4 py-2 text-sm text-gray-700 focus:outline-none shadow-lg" placeholder="Digite aqui..." autocomplete="off">
                        <button onclick="submitChat()" class="bg-white text-[#F27A23] p-2 rounded-full shadow-lg hover:bg-gray-100"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                    <div id="inputAreaOptions" class="hidden flex flex-wrap gap-2 justify-center"></div>
                    <div id="inputAreaUpload" class="hidden flex justify-center">
                         <label class="cursor-pointer bg-white text-[#F27A23] px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-gray-100">
                            <i data-lucide="camera"></i> Tirar/Escolher Foto
                            <input type="file" id="photoUpload" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                        </label>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: RECOVERY -->
            <div id="viewRecovery" class="hidden-view animate-fade-in flex flex-col justify-center h-full">
                <button onclick="switchView('viewLogin')" class="absolute top-4 left-4 text-white"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-white text-2xl font-bold text-center mb-2">Recuperar Senha</h2>
                <p class="text-white/80 text-center text-sm mb-6">Digite seu nome completo para localizarmos seu cadastro.</p>
                <form id="recoveryForm" class="space-y-4">
                    <div class="relative">
                        <input type="text" id="recNome" placeholder="Nome Completo" class="w-full bg-white text-gray-700 rounded-lg py-3 px-4 outline-none focus:ring-2 focus:ring-orange-300 shadow-sm">
                    </div>
                    <button type="submit" class="w-full bg-white text-[#F27A23] font-bold py-3 rounded-lg shadow-lg mt-2">Enviar C√≥digo</button>
                </form>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl text-white font-semibold text-sm z-50 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none"></div>

    <script>
        // --- L√ìGICA DE API INTEGRADA ---
        // Aqui implementamos a fun√ß√£o de conex√£o usando a vari√°vel do arquivo apisistema.js
        
        async function apiRequest(endpoint, method = 'GET', body = null) {
            // Verifica se a vari√°vel do arquivo externo foi carregada
            const baseUrl = (typeof API_BASE_URL !== 'undefined') ? API_BASE_URL : 'http://localhost:3005/api';
            const url = `${baseUrl}${endpoint}`;

            const headers = { 'Content-Type': 'application/json' };
            const token = localStorage.getItem('guardiao_token');
            if (token) headers['Authorization'] = `Bearer ${token}`;

            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);

            try {
                // Tenta fetch real
                const response = await fetch(url, options);
                const data = await response.json();
                if (!response.ok) throw new Error(data.mensagem || `Erro ${response.status}`);
                return data;
            } catch (error) {
                // Se falhar (ex: API offline no preview), simula resposta para n√£o travar a UI
                console.warn("API Falhou, usando Mock local para demonstra√ß√£o:", error);
                return mockLocalResponse(endpoint, body);
            }
        }

        // --- MOCK LOCAL (Para demonstra√ß√£o visual) ---
        function mockLocalResponse(endpoint, body) {
            return new Promise(resolve => {
                setTimeout(() => {
                    if (endpoint === '/auth/login') {
                        if (body.cpf_cnpj === '00000000000') resolve({ sucesso: false, mensagem: 'Inv√°lido' });
                        else resolve({ sucesso: true, dados: { token: 'mock123', usuario: { nome_completo: 'Usu√°rio Demo', foto_perfil: 'https://via.placeholder.com/150' } } });
                    } else if (endpoint === '/auth/register') {
                        resolve({ sucesso: true, dados: { token: 'mockNew', usuario: { ...body } } });
                    } else {
                        resolve({ sucesso: true, mensagem: 'Sucesso' });
                    }
                }, 1000);
            });
        }

        // --- APP LOGIC ---
        let registerState = { step: 0, data: {} };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkAuth();
            setupMasks();
            document.getElementById('loginForm').addEventListener('submit', handleLoginSubmit);
            document.getElementById('recoveryForm').addEventListener('submit', handleRecoverySubmit);
            document.getElementById('chatInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') submitChat(); });
        });

        function switchView(viewId) {
            ['viewLogin', 'viewLoggedIn', 'viewRegister', 'viewRecovery'].forEach(id => document.getElementById(id).classList.add('hidden-view'));
            document.getElementById(viewId).classList.remove('hidden-view');
            const card = document.getElementById('mainCard');
            if (viewId === 'viewRegister') { card.style.height = '600px'; card.classList.replace('p-6', 'p-4'); }
            else { card.style.height = 'auto'; card.style.minHeight = '400px'; card.classList.replace('p-4', 'p-6'); }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl text-white font-semibold text-sm z-50 transition-all duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-red-500'}`;
            toast.innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-[-20px]'), 3000);
        }

        function checkAuth() {
            const u = localStorage.getItem('guardiao_user');
            const t = localStorage.getItem('guardiao_token');
            if (u && t) {
                const user = JSON.parse(u);
                document.getElementById('userAvatar').src = user.foto_perfil || 'https://via.placeholder.com/150';
                const name = user.nome_completo ? user.nome_completo.split(' ')[0] : 'Usu√°rio';
                document.getElementById('userName').innerText = name;
                document.getElementById('btnUserName').innerText = name;
                switchView('viewLoggedIn');
            } else { switchView('viewLogin'); }
        }

        async function handleLoginSubmit(e) {
            e.preventDefault();
            const c = document.getElementById('loginCpf').value.replace(/\D/g, '');
            const s = document.getElementById('loginSenha').value;
            if (!c || !s) return showToast('Preencha tudo', 'error');
            showToast('Entrando...', 'success');
            const res = await apiRequest('/auth/login', 'POST', { cpf_cnpj: c, senha: s });
            if (res.sucesso) {
                localStorage.setItem('guardiao_token', res.dados.token);
                localStorage.setItem('guardiao_user', JSON.stringify(res.dados.usuario));
                showToast('Sucesso!', 'success');
                setTimeout(() => window.location.href = 'facial.tokem.html', 1000);
            } else { showToast(res.mensagem || 'Erro', 'error'); }
        }

        function handleQuickLogin() { window.location.href = 'facial.tokem.html'; }
        function logout() { localStorage.clear(); document.getElementById('loginForm').reset(); switchView('viewLogin'); }
        
        async function handleRecoverySubmit(e) {
            e.preventDefault();
            const n = document.getElementById('recNome').value;
            if(!n) return;
            const res = await apiRequest('/auth/recuperar-senha', 'POST', { nome_completo: n });
            if(res.sucesso) { showToast('Email enviado!', 'success'); setTimeout(() => switchView('viewLogin'), 2000); }
            else showToast('Erro', 'error');
        }

        // Chat Logic
        const chatFlow = [
            { field: 'nome_completo', msg: 'Ol√°! Bem-vindo. Qual seu **Nome Completo**?', type: 'text' },
            { field: 'tipo_acesso', msg: 'Qual seu perfil?', type: 'options', options: [{label: 'üë¥ Idoso/Fam√≠lia', value:'usuario'}, {label: 'ü©∫ Cuidador', value:'prestador'}] },
            { field: 'cpf_cnpj', msg: 'Seu **CPF**?', type: 'text', mask: 'cpf' },
            { field: 'email', msg: 'Seu **E-mail**?', type: 'text', validate: v=>v.includes('@') },
            { field: 'celular', msg: 'Seu **Celular**?', type: 'text', mask: 'phone' },
            { field: 'sexo', msg: 'G√™nero?', type: 'options', options: [{label:'M', value:'Masculino'}, {label:'F', value:'Feminino'}] },
            { field: 'cep', msg: 'Seu **CEP**?', type: 'text', mask: 'cep' },
            { field: 'senha', msg: 'Crie uma **Senha**.', type: 'password' },
            { field: 'foto_base64', msg: 'Sua **Foto de Perfil**.', type: 'upload' },
            { field: 'termos', msg: 'Aceita os termos? <a href="pdf.termo.pdf" class="underline">Ler PDF</a>', type: 'options', options: [{label:'‚úÖ Sim', value:'true'}] }
        ];

        function startRegistration() { registerState = {step:0, data:{}}; document.getElementById('chatMessages').innerHTML=''; switchView('viewRegister'); addBotMsg(chatFlow[0].msg); setupInput(chatFlow[0]); }
        function cancelRegistration() { switchView('viewLogin'); }
        function addBotMsg(t) { const d=document.createElement('div'); d.className='chat-bubble chat-bot'; d.innerHTML=t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>'); document.getElementById('chatMessages').appendChild(d); scrollChat(); }
        function addUserMsg(t) { const d=document.createElement('div'); d.className='chat-bubble chat-user'; d.innerHTML=t; document.getElementById('chatMessages').appendChild(d); scrollChat(); }
        function scrollChat() { const c=document.getElementById('chatMessages'); c.scrollTop=c.scrollHeight; }

        function setupInput(cfg) {
            const txt=document.getElementById('inputAreaText'), opt=document.getElementById('inputAreaOptions'), upl=document.getElementById('inputAreaUpload'), inp=document.getElementById('chatInput');
            txt.classList.add('hidden'); opt.classList.add('hidden'); upl.classList.add('hidden'); opt.innerHTML=''; inp.value=''; inp.type=cfg.type==='password'?'password':'text';
            
            if(cfg.type==='text'||cfg.type==='password') {
                txt.classList.remove('hidden'); inp.focus();
                if(cfg.mask==='cpf') setupCpfMask(inp); if(cfg.mask==='phone') setupPhoneMask(inp); if(cfg.mask==='cep') setupCepMask(inp);
            } else if(cfg.type==='options') {
                opt.classList.remove('hidden');
                cfg.options.forEach(o => { const b=document.createElement('button'); b.className='bg-white text-orange-500 border border-orange-500 px-4 py-2 rounded-full text-sm mr-2 mb-1'; b.innerText=o.label; b.onclick=()=>processStep(o.value, o.label); opt.appendChild(b); });
            } else if(cfg.type==='upload') { upl.classList.remove('hidden'); }
        }

        function submitChat() { const v=document.getElementById('chatInput').value.trim(); if(v) processStep(v,v); }
        function handlePhotoUpload(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{ addUserMsg(`<img src="${e.target.result}" class="w-20 h-20 rounded-full">`); processStep(e.target.result,'Foto',true); }; r.readAsDataURL(i.files[0]); } }

        async function processStep(val, display, skip=false) {
            const cfg = chatFlow[registerState.step];
            if(cfg.validate && !cfg.validate(val)) return addBotMsg('Inv√°lido.');
            if(cfg.field==='cpf_cnpj' && val.replace(/\D/g,'').length<11) return addBotMsg('CPF inv√°lido.');
            
            if(!skip) addUserMsg(display);
            registerState.data[cfg.field] = val;
            registerState.step++;

            if(registerState.step < chatFlow.length) { setTimeout(()=> { addBotMsg(chatFlow[registerState.step].msg); setupInput(chatFlow[registerState.step]); }, 500); }
            else { addBotMsg('Criando conta...'); finishReg(); }
        }

        async function finishReg() {
            const d = {...registerState.data, rua:'-', cidade:'-', estado:'UF', bairro:'-', latitude:0, longitude:0};
            d.cpf_cnpj=d.cpf_cnpj.replace(/\D/g,''); d.celular=d.celular.replace(/\D/g,'');
            const res = await apiRequest('/auth/register', 'POST', d);
            if(res.sucesso) { 
                addBotMsg('Sucesso! Redirecionando...'); 
                localStorage.setItem('guardiao_token', res.dados.token);
                localStorage.setItem('guardiao_user', JSON.stringify(res.dados.usuario));
                setTimeout(()=>window.location.href='facial.tokem.html', 2000);
            } else { addBotMsg('Erro: '+res.mensagem); setTimeout(cancelRegistration, 3000); }
        }

        function setupCpfMask(i) { i.oninput=e=>{ let v=e.target.value.replace(/\D/g,''); if(v.length>11) v=v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,"$1.$2.$3/$4-$5"); else v=v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4"); e.target.value=v; } }
        function setupPhoneMask(i) { i.oninput=e=>{ let v=e.target.value.replace(/\D/g,''); v=v.replace(/^(\d{2})(\d{5})(\d{4})/,"($1) $2-$3"); e.target.value=v; } }
        function setupCepMask(i) { i.oninput=e=>{ let v=e.target.value.replace(/\D/g,''); v=v.replace(/^(\d{5})(\d{3})/,"$1-$2"); e.target.value=v; } }
    </script>
</body>
</html>