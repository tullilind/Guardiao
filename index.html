<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardi√£o - Acesso</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- √çcones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Importa√ß√£o da API Base -->
    <script src="apisistema.js"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F27A23; }
        
        /* Tipografia Decorativa */
        .outline-text { color: transparent; -webkit-text-stroke: 2px rgba(255, 255, 255, 0.5); font-weight: 900; line-height: 1; }
        
        /* Anima√ß√µes */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeInUp 0.4s ease-out forwards; }
        
        /* Estilo Profissional do Chat */
        .chat-bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 18px;
            margin-bottom: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: fadeInUp 0.3s ease-out;
            position: relative;
        }
        
        .chat-bot {
            background-color: #ffffff;
            color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #f3f4f6;
        }
        
        .chat-user {
            background-color: #FDBA74; /* Laranja suave */
            color: #7c2d12;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            font-weight: 600;
            text-align: right;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.2);
        }

        /* Scrollbar Invis√≠vel mas funcional */
        .chat-container::-webkit-scrollbar { width: 4px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 10px; }

        .hidden-view { display: none !important; }
        
        /* Ajuste para inputs focados n√£o darem zoom no iPhone */
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden relative bg-[#F27A23]">

    <!-- ================= FUNDO DECORATIVO ================= -->
    <div class="pointer-events-none select-none absolute inset-0 z-0">
        <div class="absolute left-0 bottom-0 h-full flex items-center justify-center w-20">
            <h1 class="outline-text text-[15vh] md:text-[20vh] tracking-widest transform -rotate-90 whitespace-nowrap origin-center opacity-60">GUARDI√ÉO</h1>
        </div>
        <div class="absolute bottom-[-5%] right-0 w-full flex justify-end pr-4 md:pr-10">
            <h1 class="outline-text text-[18vh] md:text-[25vh] tracking-tighter opacity-60 translate-y-4">I√ÉO</h1>
        </div>
        <div class="absolute top-0 right-0 h-full w-1/2 overflow-hidden">
             <svg viewBox="0 0 200 400" preserveAspectRatio="none" class="h-full w-full text-white opacity-90 float-right">
                <path fill="currentColor" d="M150,0 C150,0 80,100 120,200 C160,300 50,400 50,400 L200,400 L200,0 Z" transform="translate(50,0) scale(1.5, 1)"/>
            </svg>
        </div>
    </div>

    <!-- ================= √ÅREA PRINCIPAL ================= -->
    <div class="relative z-10 w-full h-full flex flex-col items-center justify-center px-4 md:px-8">
        
        <!-- LOGO -->
        <div class="mb-4 flex justify-center transition-all duration-500 relative z-20" id="logoContainer">
            <img src="logo.sem.png" alt="Logo Guardi√£o" class="w-24 md:w-28 drop-shadow-lg">
        </div>

        <!-- CONTAINER DOS VIEWS (CARD) -->
        <div class="w-full max-w-md bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl border border-white/50 relative overflow-hidden transition-all duration-500 ease-in-out flex flex-col" id="mainCard" style="min-height: 420px; max-height: 85vh;">
            
            <!-- VIEW 1: LOGIN FORM -->
            <div id="viewLogin" class="animate-fade-in flex flex-col justify-center p-8 h-full">
                <div class="text-center mb-8">
                    <h2 class="text-gray-800 text-2xl font-bold">Bem-vindo</h2>
                    <p class="text-gray-500 text-sm mt-1">Acesse sua conta para continuar</p>
                </div>
                
                <form id="loginForm" class="space-y-5">
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="user" class="text-gray-400 w-5 h-5"></i>
                        </div>
                        <input type="text" id="loginCpf" placeholder="CPF ou CNPJ" maxlength="18" 
                            class="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl leading-5 bg-gray-50 text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-orange-400 focus:border-transparent transition-all shadow-sm font-medium">
                    </div>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="lock" class="text-gray-400 w-5 h-5"></i>
                        </div>
                        <input type="password" id="loginSenha" placeholder="Senha" 
                            class="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl leading-5 bg-gray-50 text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-orange-400 focus:border-transparent transition-all shadow-sm font-medium">
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-[#F27A23] to-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-xl active:scale-[0.98] transition-all uppercase tracking-wide text-sm mt-2">
                        Entrar
                    </button>
                </form>

                <div class="flex justify-between items-center mt-8 text-sm font-medium">
                    <button onclick="switchView('viewRecovery')" class="text-gray-500 hover:text-orange-600 transition-colors">Esqueci a senha</button>
                    <button onclick="startRegistration()" class="text-orange-600 hover:text-orange-700 bg-orange-50 px-4 py-1.5 rounded-full border border-orange-100 hover:bg-orange-100 transition-all">Criar Conta</button>
                </div>
            </div>

            <!-- VIEW 2: LOGGED IN -->
            <div id="viewLoggedIn" class="hidden-view animate-fade-in flex flex-col items-center justify-center p-8 h-full text-center">
                <div class="relative mb-6">
                    <div class="w-24 h-24 rounded-full border-4 border-orange-100 overflow-hidden shadow-xl">
                        <img id="userAvatar" src="" alt="Foto Usu√°rio" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute bottom-1 right-1 bg-green-500 w-5 h-5 rounded-full border-2 border-white animate-pulse"></div>
                </div>
                
                <h3 class="text-gray-800 text-xl font-bold mb-1">Ol√°, <span id="userName" class="text-[#F27A23]">Usu√°rio</span>!</h3>
                <p class="text-gray-500 text-sm mb-8">√â bom te ver por aqui.</p>

                <button onclick="handleQuickLogin()" class="w-full bg-[#F27A23] text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-orange-600 active:scale-[0.98] transition-all mb-3">
                    Continuar Acesso
                </button>
                
                <button onclick="logout()" class="text-gray-400 text-sm hover:text-gray-600 font-medium py-2">
                    Entrar com outra conta
                </button>
            </div>

            <!-- VIEW 3: CHAT REGISTER (Atualizado) -->
            <div id="viewRegister" class="hidden-view flex flex-col h-[550px] bg-gray-50">
                <!-- Header Profissional -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-b border-gray-100 shadow-sm z-10">
                    <button onclick="cancelRegistration()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full transition-colors"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <div class="flex flex-col items-center">
                        <span class="text-gray-800 font-bold text-sm">Cadastro Guardi√£o</span>
                        <span class="text-[#F27A23] text-xs font-medium">Assistente Virtual</span>
                    </div>
                    <div class="w-9 h-9 rounded-full bg-orange-100 flex items-center justify-center text-[#F27A23]">
                        <i data-lucide="bot" class="w-5 h-5"></i>
                    </div>
                </div>

                <!-- √Årea de Mensagens -->
                <div id="chatMessages" class="flex-1 overflow-y-auto chat-container flex flex-col p-4 space-y-2 bg-slate-50">
                    <!-- Mensagens din√¢micas -->
                </div>

                <!-- √Årea de Input -->
                <div class="bg-white p-3 border-t border-gray-100 relative shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                    
                    <!-- Input de Texto -->
                    <div id="inputAreaText" class="flex gap-2 items-center">
                        <input type="text" id="chatInput" class="flex-1 bg-gray-100 text-gray-800 rounded-full px-5 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300 focus:bg-white transition-all shadow-inner" placeholder="Digite sua resposta..." autocomplete="off">
                        <button onclick="submitChat()" class="bg-[#F27A23] text-white p-3 rounded-full shadow-lg hover:bg-orange-600 active:scale-90 transition-all">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <!-- Bot√µes de Op√ß√£o -->
                    <div id="inputAreaOptions" class="hidden flex flex-col gap-2 w-full">
                        <!-- Bot√µes injetados via JS -->
                    </div>

                    <!-- Bot√£o Upload -->
                    <div id="inputAreaUpload" class="hidden flex justify-center py-2">
                         <label class="cursor-pointer bg-white text-[#F27A23] border-2 border-[#F27A23] px-6 py-3 rounded-full font-bold shadow-sm flex items-center gap-2 hover:bg-orange-50 w-full justify-center transition-all active:scale-95">
                            <i data-lucide="camera" class="w-5 h-5"></i> Tirar ou Escolher Foto
                            <input type="file" id="photoUpload" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                        </label>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: RECOVERY -->
            <div id="viewRecovery" class="hidden-view animate-fade-in flex flex-col justify-center p-8 h-full bg-white">
                <button onclick="switchView('viewLogin')" class="absolute top-6 left-6 text-gray-400 hover:text-gray-600"><i data-lucide="arrow-left"></i></button>
                <div class="text-center mb-6 mt-4">
                    <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-[#F27A23]">
                        <i data-lucide="key-round" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-gray-800 text-2xl font-bold">Recuperar Senha</h2>
                    <p class="text-gray-500 text-sm mt-2 px-4">Informe seu nome completo para buscarmos seu cadastro.</p>
                </div>
                
                <form id="recoveryForm" class="space-y-4">
                    <div class="relative">
                        <input type="text" id="recNome" placeholder="Nome Completo" 
                            class="block w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-300 outline-none transition-all text-gray-800 font-medium">
                    </div>
                    <button type="submit" class="w-full bg-[#F27A23] text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 hover:bg-orange-600 transition-all">Enviar C√≥digo</button>
                </form>
            </div>

        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-2xl text-white font-semibold text-sm z-50 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-2"></div>

    <script>
        // --- API HELPERS ---
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const baseUrl = (typeof API_BASE_URL !== 'undefined') ? API_BASE_URL : 'http://localhost:3005/api';
            const url = `${baseUrl}${endpoint}`;
            const headers = { 'Content-Type': 'application/json' };
            const token = localStorage.getItem('guardiao_token');
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                if (!response.ok) throw new Error(data.mensagem || `Erro ${response.status}`);
                return data;
            } catch (error) {
                console.warn("API Error (Mocking response):", error);
                return mockLocalResponse(endpoint, body);
            }
        }

        function mockLocalResponse(endpoint, body) {
            return new Promise(resolve => {
                setTimeout(() => {
                    if (endpoint === '/auth/login') {
                        if (body.cpf_cnpj === '00000000000') resolve({ sucesso: false, mensagem: 'Credenciais inv√°lidas' });
                        else resolve({ sucesso: true, dados: { token: 'mock123', usuario: { nome_completo: 'Usu√°rio Teste', foto_perfil: 'https://via.placeholder.com/150' } } });
                    } else if (endpoint === '/auth/register') {
                        resolve({ sucesso: true, dados: { token: 'mockNew', usuario: { ...body } } });
                    } else {
                        resolve({ sucesso: true, mensagem: 'Opera√ß√£o realizada' });
                    }
                }, 800);
            });
        }

        // --- APP LOGIC ---
        let registerState = { step: 0, data: {} };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkAuth();
            setupMasks();
            document.getElementById('loginForm').addEventListener('submit', handleLoginSubmit);
            document.getElementById('recoveryForm').addEventListener('submit', handleRecoverySubmit);
            document.getElementById('chatInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') submitChat(); });
        });

        function switchView(viewId) {
            ['viewLogin', 'viewLoggedIn', 'viewRegister', 'viewRecovery'].forEach(id => document.getElementById(id).classList.add('hidden-view'));
            document.getElementById(viewId).classList.remove('hidden-view');
            
            const card = document.getElementById('mainCard');
            if (viewId === 'viewRegister') { 
                card.style.height = '600px'; 
                card.classList.remove('bg-white/95');
                card.classList.add('bg-white'); 
            } else { 
                card.style.height = 'auto'; 
                card.classList.add('bg-white/95');
            }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = type === 'success' ? '<i data-lucide="check-circle" class="w-5 h-5"></i>' : '<i data-lucide="alert-circle" class="w-5 h-5"></i>';
            toast.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-2xl text-white font-semibold text-sm z-50 transition-all duration-300 flex items-center gap-2 ${type === 'success' ? 'bg-emerald-600' : 'bg-red-500'}`;
            toast.innerHTML = `${icon} ${msg}`;
            lucide.createIcons();
            
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-[-20px]'), 3500);
        }

        function checkAuth() {
            const u = localStorage.getItem('guardiao_user');
            const t = localStorage.getItem('guardiao_token');
            if (u && t) {
                const user = JSON.parse(u);
                document.getElementById('userAvatar').src = user.foto_perfil || 'https://ui-avatars.com/api/?name=' + user.nome_completo + '&background=F27A23&color=fff';
                const name = user.nome_completo ? user.nome_completo.split(' ')[0] : 'Usu√°rio';
                document.getElementById('userName').innerText = name;
                switchView('viewLoggedIn');
            } else { switchView('viewLogin'); }
        }

        async function handleLoginSubmit(e) {
            e.preventDefault();
            const c = document.getElementById('loginCpf').value.replace(/\D/g, '');
            const s = document.getElementById('loginSenha').value;
            if (!c || !s) return showToast('Preencha todos os campos', 'error');
            
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Autenticando...';
            btn.disabled = true;

            const res = await apiRequest('/auth/login', 'POST', { cpf_cnpj: c, senha: s });
            
            btn.innerText = originalText;
            btn.disabled = false;

            if (res.sucesso) {
                localStorage.setItem('guardiao_token', res.dados.token);
                localStorage.setItem('guardiao_user', JSON.stringify(res.dados.usuario));
                showToast('Acesso concedido!', 'success');
                setTimeout(() => window.location.href = 'facial.tokem.html', 800);
            } else { showToast(res.mensagem || 'Credenciais incorretas', 'error'); }
        }

        function handleQuickLogin() { window.location.href = 'facial.tokem.html'; }
        function logout() { localStorage.clear(); document.getElementById('loginForm').reset(); switchView('viewLogin'); }
        
        async function handleRecoverySubmit(e) {
            e.preventDefault();
            const n = document.getElementById('recNome').value;
            if(!n) return showToast('Digite seu nome', 'error');
            
            const res = await apiRequest('/auth/recuperar-senha', 'POST', { nome_completo: n });
            if(res.sucesso) { showToast('C√≥digo enviado para seu e-mail/SMS!', 'success'); setTimeout(() => switchView('viewLogin'), 3000); }
            else showToast('Usu√°rio n√£o encontrado', 'error');
        }

        // --- L√ìGICA DO CHAT ---
        const chatFlow = [
            { field: 'nome_completo', msg: 'Ol√°! Sou o assistente do Guardi√£o. Vamos configurar sua conta. üòä<br>Primeiro, como devo te chamar? (<b>Nome Completo</b>)', type: 'text' },
            { 
                field: 'tipo_acesso', 
                msg: 'Prazer! Qual perfil de acesso voc√™ precisa? (Selecione uma das 4 op√ß√µes)', 
                type: 'options', 
                options: [
                    { label: 'üßë‚Äçüßë Familiar / Respons√°vel', value: 'familiar' },
                    { label: 'üë¥ Idoso / Assistido', value: 'idoso' },
                    { label: 'ü©∫ Cuidador Profissional', value: 'cuidador' },
                    { label: 'üè• Profissional de Sa√∫de', value: 'saude' }
                ] 
            },
            { field: 'cpf_cnpj', msg: 'Entendido. Agora, digite seu <b>CPF</b> (somente n√∫meros).', type: 'text', mask: 'cpf' },
            { field: 'email', msg: 'Qual seu melhor <b>E-mail</b> para contato?', type: 'text', validate: v=>v.includes('@') && v.includes('.') },
            { field: 'celular', msg: 'E seu n√∫mero de <b>Celular</b> (WhatsApp)?', type: 'text', mask: 'phone' },
            { field: 'sexo', msg: 'Como voc√™ se identifica?', type: 'options', options: [{label:'Masculino', value:'Masculino'}, {label:'Feminino', value:'Feminino'}, {label:'Outro', value:'Outro'}] },
            { field: 'cep', msg: 'Informe seu <b>CEP</b> para localizarmos cuidadores pr√≥ximos.', type: 'text', mask: 'cep' },
            { field: 'senha', msg: 'Quase l√°! Crie uma <b>Senha</b> segura (m√≠nimo 6 d√≠gitos).', type: 'password' },
            { field: 'foto_base64', msg: 'Para finalizar, adicione uma <b>Foto de Perfil</b> bonita! üì∏', type: 'upload' },
            { field: 'termos', msg: 'Voc√™ aceita os <a href="pdf.termo.pdf" class="text-orange-600 font-bold underline">Termos de Uso</a> e Pol√≠tica de Privacidade?', type: 'options', options: [{label:'‚úÖ Li e Concordo com Tudo', value:'true'}] }
        ];

        function startRegistration() { registerState = {step:0, data:{}}; document.getElementById('chatMessages').innerHTML=''; switchView('viewRegister'); addBotMsg(chatFlow[0].msg); setupInput(chatFlow[0]); }
        function cancelRegistration() { switchView('viewLogin'); }
        
        function addBotMsg(t) { 
            const d=document.createElement('div'); 
            d.className='chat-bubble chat-bot'; 
            d.innerHTML=t; 
            document.getElementById('chatMessages').appendChild(d); 
            scrollChat(); 
        }
        
        function addUserMsg(t) { 
            const d=document.createElement('div'); 
            d.className='chat-bubble chat-user'; 
            d.innerHTML=t; 
            document.getElementById('chatMessages').appendChild(d); 
            scrollChat(); 
        }
        
        function scrollChat() { 
            const c=document.getElementById('chatMessages'); 
            setTimeout(() => { c.scrollTop = c.scrollHeight; }, 50);
        }

        function setupInput(cfg) {
            const txt=document.getElementById('inputAreaText');
            const opt=document.getElementById('inputAreaOptions');
            const upl=document.getElementById('inputAreaUpload');
            const inp=document.getElementById('chatInput');

            txt.classList.add('hidden'); 
            opt.classList.add('hidden'); 
            upl.classList.add('hidden'); 
            opt.innerHTML=''; 
            inp.value=''; 
            inp.type = cfg.type === 'password' ? 'password' : 'text';
            inp.oninput = null; 

            if(cfg.type==='text'||cfg.type==='password') {
                txt.classList.remove('hidden'); 
                inp.focus();
                if(cfg.mask==='cpf') setupCpfMask(inp); 
                if(cfg.mask==='phone') setupPhoneMask(inp); 
                if(cfg.mask==='cep') setupCepMask(inp);
            } else if(cfg.type==='options') {
                opt.classList.remove('hidden');
                cfg.options.forEach(o => { 
                    const b=document.createElement('button'); 
                    b.className='w-full bg-white border border-gray-200 text-gray-700 hover:bg-orange-50 hover:border-orange-300 hover:text-orange-700 font-semibold py-3 px-4 rounded-xl text-left shadow-sm transition-all active:scale-[0.99] flex items-center justify-between group';
                    b.innerHTML = `<span>${o.label}</span> <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 group-hover:text-orange-400"></i>`;
                    b.onclick=()=>processStep(o.value, o.label); 
                    opt.appendChild(b); 
                });
                lucide.createIcons();
            } else if(cfg.type==='upload') { 
                upl.classList.remove('hidden'); 
            }
        }

        function submitChat() { const v=document.getElementById('chatInput').value.trim(); if(v) processStep(v,v); }
        function handlePhotoUpload(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{ addUserMsg(`<img src="${e.target.result}" class="w-24 h-24 rounded-full border-4 border-white shadow-md">`); processStep(e.target.result,'Foto definida',true); }; r.readAsDataURL(i.files[0]); } }

        async function processStep(val, display, skip=false) {
            const cfg = chatFlow[registerState.step];
            
            // Valida√ß√µes B√°sicas
            if(cfg.validate && !cfg.validate(val)) return addBotMsg('<span class="text-red-500 font-bold">‚ö†Ô∏è Formato inv√°lido.</span><br>Por favor, verifique e tente novamente.');
            if(cfg.field==='cpf_cnpj' && val.replace(/\D/g,'').length<11) return addBotMsg('‚ö†Ô∏è CPF precisa ter 11 d√≠gitos.');
            
            // --- INTEGRA√á√ÉO VIACEP ---
            // Verifica se √© o campo de CEP para buscar endere√ßo
            if(cfg.field === 'cep') {
                const cleanCep = val.replace(/\D/g, '');
                
                if(cleanCep.length !== 8) {
                    return addBotMsg('‚ö†Ô∏è CEP deve ter 8 d√≠gitos num√©ricos.');
                }

                // Mostra input do usu√°rio antes de buscar
                if(!skip) addUserMsg(display);
                
                // Feedback de busca
                addBotMsg('üîç <i>Buscando endere√ßo...</i>');

                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
                    const addressData = await response.json();

                    if(addressData.erro) {
                        addBotMsg('‚ö†Ô∏è CEP n√£o encontrado. Por favor, verifique e tente novamente.');
                        return; // Impede avan√ßo se CEP for inv√°lido na API
                    }

                    // Salva dados do endere√ßo no estado global
                    registerState.data.rua = addressData.logradouro || '';
                    registerState.data.bairro = addressData.bairro || '';
                    registerState.data.cidade = addressData.localidade || '';
                    registerState.data.estado = addressData.uf || '';

                    // Bot confirma endere√ßo encontrado
                    addBotMsg(`‚úÖ <b>Endere√ßo localizado:</b><br>${addressData.logradouro}, ${addressData.bairro}<br>${addressData.localidade} - ${addressData.uf}`);

                } catch (error) {
                    console.error("Erro ViaCEP:", error);
                    addBotMsg('‚ö†Ô∏è Erro ao consultar CEP. Vamos seguir apenas com o n√∫mero.');
                }
            } else {
                // Comportamento padr√£o para outros campos
                if(!skip) addUserMsg(display);
            }

            // Salva o valor do campo atual
            registerState.data[cfg.field] = val;
            registerState.step++;

            if(registerState.step < chatFlow.length) { 
                setTimeout(()=> { 
                    addBotMsg(chatFlow[registerState.step].msg); 
                    setupInput(chatFlow[registerState.step]); 
                }, 600); 
            } else { 
                addBotMsg('Perfeito! Criando sua conta...'); 
                finishReg(); 
            }
        }

        async function finishReg() {
            // Prepara payload final mesclando dados capturados (incluindo endere√ßo do ViaCEP)
            const d = {
                rua: 'N/A', 
                cidade: 'N/A', 
                estado: 'UF', 
                bairro: 'N/A', 
                latitude: 0, 
                longitude: 0,
                ...registerState.data // Dados do chat e ViaCEP sobrescrevem os defaults
            };
            
            // Limpeza final de dados
            d.cpf_cnpj = d.cpf_cnpj.replace(/\D/g,''); 
            d.celular = d.celular.replace(/\D/g,'');
            
            const res = await apiRequest('/auth/register', 'POST', d);
            
            if(res.sucesso) { 
                addBotMsg('<b>üéâ Sucesso!</b><br>Conta criada. Entrando...'); 
                localStorage.setItem('guardiao_token', res.dados.token);
                localStorage.setItem('guardiao_user', JSON.stringify(res.dados.usuario));
                setTimeout(()=>window.location.href='facial.tokem.html', 2500);
            } else { 
                addBotMsg('‚ùå <b>Erro:</b> '+res.mensagem); 
                setTimeout(() => {
                    addBotMsg('Reiniciando cadastro...');
                    setTimeout(startRegistration, 2000);
                }, 3000);
            }
        }

        // --- M√ÅSCARAS ---
        function setupMasks() { const i=document.getElementById('loginCpf'); setupCpfMask(i); }
        function setupCpfMask(i) { i.oninput=e=>{ let v=e.target.value.replace(/\D/g,''); if(v.length>11) v=v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,"$1.$2.$3/$4-$5"); else v=v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4"); e.target.value=v; } }
        function setupPhoneMask(i) { i.oninput=e=>{ let v=e.target.value.replace(/\D/g,''); v=v.replace(/^(\d{2})(\d{5})(\d{4})/,"($1) $2-$3"); e.target.value=v; } }
        function setupCepMask(i) { i.oninput=e=>{ let v=e.target.value.replace(/\D/g,''); v=v.replace(/^(\d{5})(\d{3})/,"$1-$2"); e.target.value=v; } }
    </script>
</body>
</html>