<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Guardião - Documentação</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Configuração da API -->
    <script src="apisistema.js"></script>

    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #F9FAFB;
            height: 100dvh;
            width: 100vw;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .header-bg {
            background: linear-gradient(135deg, #F27A23 0%, #e06000 100%);
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 25px -5px rgba(242, 122, 35, 0.3);
        }

        .doc-card {
            transition: all 0.3s ease;
            border: 1px solid #eee;
        }
        .doc-card:active { transform: scale(0.98); }

        .status-badge {
            font-size: 0.7rem; padding: 4px 10px; border-radius: 20px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }

        .status-pendente { background-color: #FEF3C7; color: #D97706; }
        .status-aprovado { background-color: #D1FAE5; color: #059669; }
        .status-rejeitado { background-color: #FEE2E2; color: #DC2626; }
        .status-vazio { background-color: #F3F4F6; color: #6B7280; }

        .hidden-view { display: none !important; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault()); 
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; 
            if(e.ctrlKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'U'.charCodeAt(0))) return false; 
        }
    </script>
</head>
<body class="flex flex-col bg-gray-50">

    <!-- Loading Screen -->
    <div id="pageLoading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
        <div class="w-16 h-16 border-4 border-orange-100 border-t-[#F27A23] rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 font-medium text-sm">Sincronizando dados...</p>
    </div>

    <!-- Conteúdo Principal -->
    <div id="mainContent" class="hidden-view flex-1 flex flex-col h-full relative">
        
        <!-- Header -->
        <div class="header-bg pt-12 pb-10 px-6 text-white relative z-10">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <i data-lucide="file-check-2" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Documentação</h1>
                        <p class="text-white/80 text-xs font-medium">Validação de Segurança</p>
                    </div>
                </div>
                <button onclick="logout()" class="text-white/80 hover:text-white"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
            
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
                <div class="flex items-center gap-3">
                    <div id="globalStatusIcon" class="w-2 h-2 rounded-full bg-gray-300"></div>
                    <p id="globalStatusText" class="text-sm font-semibold">Verificando status...</p>
                </div>
                <p class="text-xs text-white/70 mt-1 leading-relaxed">
                    Envie seu documento de identificação para ativar seu perfil profissional.
                </p>
            </div>
        </div>

        <!-- Lista de Documentos -->
        <div class="flex-1 overflow-y-auto px-6 -mt-6 pb-28 z-20">
            <div class="bg-white rounded-2xl shadow-xl p-2 space-y-2" id="documentsList">
                <!-- Lista dinâmica -->
            </div>
        </div>

        <!-- Botão de Ação (Final) -->
        <div id="actionArea" class="hidden-view fixed bottom-0 left-0 w-full p-6 bg-white border-t border-gray-100 z-30 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            <button onclick="goToDashboard()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-green-600 transition-all flex items-center justify-center gap-2 transform active:scale-[0.98]">
                <i data-lucide="check-circle-2"></i> Tudo Pronto! Acessar App
            </button>
        </div>
    </div>

    <!-- 1. MODAL DE AVISO LEGAL (ATUALIZADO) -->
    <div id="infoModal" class="hidden-view fixed inset-0 z-50 flex items-end justify-center sm:items-center bg-black/80 backdrop-blur-sm fade-in">
        <div class="bg-white w-full max-w-md rounded-t-[2rem] sm:rounded-3xl p-6 animate-slide-up shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-[#F27A23] to-orange-400"></div>

            <div class="flex flex-col items-center text-center mb-5 mt-2">
                <div class="w-14 h-14 bg-blue-50 rounded-full flex items-center justify-center mb-3 text-blue-600 ring-4 ring-blue-50/50">
                    <i data-lucide="shield-alert" class="w-7 h-7"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">Aviso Importante</h2>
            </div>

            <div class="space-y-4 text-sm text-gray-600 bg-gray-50 p-5 rounded-2xl border border-gray-100 max-h-[60vh] overflow-y-auto leading-relaxed text-justify">
                <p>
                    De acordo com os <strong>termos da plataforma</strong>, é <strong>obrigatório e indispensável</strong> o envio dos documentos para validação de seus dados junto à plataforma Guardião.
                </p>
                <p>
                    Atualmente, a plataforma realiza uma <strong>validação manual</strong> por nossa equipe de segurança. Em breve, utilizaremos modelos avançados de <strong>Inteligência Artificial</strong> para realizar essa validação de forma automática.
                </p>
                <p>
                    Garantimos que seus dados são guardados de forma segura em nossos servidores e <strong>jamais serão compartilhados com terceiros</strong>, mantendo total privacidade e segurança das suas informações.
                </p>
            </div>

            <div class="mt-6 flex flex-col gap-3">
                <button onclick="confirmInfoAndOpenUpload()" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="check"></i> Estou Ciente e Concordo
                </button>
                <button onclick="closeInfoModal()" class="w-full text-gray-400 font-medium py-2 hover:text-gray-600 transition-colors text-xs">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- 2. MODAL DE UPLOAD (MÚLTIPLOS ARQUIVOS) -->
    <div id="uploadModal" class="hidden-view fixed inset-0 z-[60] flex items-end justify-center sm:items-center bg-black/60 backdrop-blur-sm fade-in">
        <div class="bg-white w-full max-w-md rounded-t-[2rem] sm:rounded-3xl p-6 animate-slide-up shadow-2xl">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
            
            <div class="flex justify-between items-start mb-1">
                <h3 class="text-lg font-bold text-gray-800" id="modalDocTitle">Enviar RG ou CNH</h3>
                <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-6">Envie fotos legíveis (Frente e Verso se necessário).</p>

            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center mb-6 hover:bg-gray-50 hover:border-orange-300 transition-all relative group cursor-pointer">
                <!-- Múltiplo permitido para enviar frente e verso de uma vez -->
                <input type="file" id="fileInput" accept="image/*,application/pdf" multiple class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleFileSelect(this)">
                
                <div id="uploadPlaceholder" class="transition-opacity">
                    <div class="w-14 h-14 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-3 text-[#F27A23] group-hover:scale-110 transition-transform">
                        <i data-lucide="layers" class="w-7 h-7"></i>
                    </div>
                    <span class="text-sm text-[#F27A23] font-bold block">Selecionar Arquivos</span>
                    <span class="text-xs text-gray-400 mt-1 block">Você pode selecionar Frente e Verso juntos</span>
                </div>
                
                <div id="uploadPreview" class="hidden flex-col items-center">
                    <div class="w-14 h-14 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-3 text-green-500">
                        <i data-lucide="file-check" class="w-7 h-7"></i>
                    </div>
                    <span id="fileName" class="text-sm font-bold text-gray-700 truncate w-full px-4"></span>
                    <span class="text-xs text-green-600 mt-1">Pronto para envio</span>
                </div>
            </div>

            <button id="btnSendDoc" onclick="submitDocumentsBatch()" disabled class="w-full bg-[#F27A23] disabled:bg-gray-200 disabled:text-gray-400 text-white font-bold py-4 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 active:scale-[0.98]">
                Enviar para Análise
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 px-5 py-3 rounded-full shadow-2xl text-white font-semibold text-xs md:text-sm z-[70] transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-3 w-max max-w-[90%] text-center"></div>

    <script>
        // --- ESTADO GLOBAL ---
        let currentUser = null;
        let token = null;
        let currentDocType = null; 
        
        // Lista simplificada para apenas 1 tipo de documento (RG ou CNH)
        const REQUIRED_DOCS = [
            { type: 'IDENTIFICACAO', label: 'RG ou CNH (Frente e Verso)', icon: 'user-square' }
        ];
        
        let userDocuments = []; 

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            try { if (window.lucide) window.lucide.createIcons(); } catch(e){}
            
            const u = localStorage.getItem('guardiao_user');
            const t = localStorage.getItem('guardiao_token');

            if (!u || !t) {
                window.location.href = 'login_guardiao.html';
                return;
            }

            currentUser = JSON.parse(u);
            token = t;

            checkUserTypeAndRoute();
        });

        function checkUserTypeAndRoute() {
            const tipo = currentUser.tipo_acesso ? currentUser.tipo_acesso.toLowerCase() : ''; 
            const isPrestador = ['cuidador', 'prestador', 'saude', 'baba', 'enfermeiro'].some(role => tipo.includes(role));

            if (isPrestador) {
                loadDocuments();
            } else {
                window.location.href = 'Sistemafamiliaidoso/boas.vindas.html'; 
            }
        }

        // --- CARREGAR DADOS ---
        async function loadDocuments() {
            try {
                const res = await apiRequest(`/documentos/usuario/${currentUser.id}`);
                
                if (res.success) {
                    userDocuments = res.data || [];
                    renderDocumentsList();
                    document.getElementById('pageLoading').classList.add('hidden-view');
                    document.getElementById('mainContent').classList.remove('hidden-view');
                } else {
                    throw new Error(res.message);
                }
            } catch (error) {
                console.error(error);
                // Se der erro (ex: 404 usuário sem documentos), mostramos lista vazia
                document.getElementById('pageLoading').classList.add('hidden-view');
                document.getElementById('mainContent').classList.remove('hidden-view');
                renderDocumentsList(); 
            }
        }

        // --- RENDERIZAÇÃO ---
        function renderDocumentsList() {
            const container = document.getElementById('documentsList');
            container.innerHTML = '';

            let allApproved = true;
            let pendingCount = 0;

            REQUIRED_DOCS.forEach(reqDoc => {
                const existingDoc = userDocuments.find(d => d.tipo_documento === reqDoc.label || d.tipo_documento === reqDoc.type);
                let statusHtml = '', actionHtml = '', statusClass = 'status-vazio', statusText = 'Não Enviado';

                if (existingDoc) {
                    if (existingDoc.status === 'Aprovado') {
                        statusClass = 'status-aprovado'; statusText = 'Aprovado';
                        actionHtml = `<div class="text-green-500 bg-green-50 p-2 rounded-full"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>`;
                    } else if (existingDoc.status === 'Rejeitado') {
                        statusClass = 'status-rejeitado'; statusText = 'Rejeitado'; allApproved = false;
                        actionHtml = `<button onclick="openInfoModal('${reqDoc.label}')" class="text-[#F27A23] text-xs font-bold border border-[#F27A23] px-4 py-2 rounded-lg hover:bg-orange-50 active:scale-95 transition-transform">Reenviar</button>`;
                    } else {
                        statusClass = 'status-pendente'; statusText = 'Em Análise'; allApproved = false; pendingCount++;
                        actionHtml = `<div class="text-yellow-500 bg-yellow-50 p-2 rounded-full animate-pulse"><i data-lucide="clock" class="w-5 h-5"></i></div>`;
                    }
                } else {
                    allApproved = false;
                    // Botão abre o modal de informações primeiro
                    actionHtml = `<button onclick="openInfoModal('${reqDoc.label}')" class="bg-[#F27A23] text-white text-xs font-bold px-4 py-2 rounded-lg shadow-md hover:bg-orange-600 active:scale-95 transition-transform flex items-center gap-1">Enviar <i data-lucide="arrow-right" class="w-3 h-3"></i></button>`;
                }

                const card = document.createElement('div');
                card.className = 'doc-card bg-white rounded-2xl p-4 flex items-center justify-between animate-slide-up shadow-sm border border-gray-100';
                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400">
                            <i data-lucide="${reqDoc.icon}" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-800 leading-tight mb-1">${reqDoc.label}</h4>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div>${actionHtml}</div>
                `;
                container.appendChild(card);
            });
            
            lucide.createIcons();
            updateGlobalStatus(allApproved, pendingCount);
        }

        function updateGlobalStatus(allApproved, pendingCount) {
            const statusText = document.getElementById('globalStatusText');
            const statusIcon = document.getElementById('globalStatusIcon');
            const actionArea = document.getElementById('actionArea');

            if (allApproved && userDocuments.length >= REQUIRED_DOCS.length) {
                statusText.innerText = "Perfil Verificado";
                statusText.className = "text-sm font-bold text-green-600";
                statusIcon.className = "w-2 h-2 rounded-full bg-green-500";
                actionArea.classList.remove('hidden-view'); 
            } else {
                actionArea.classList.add('hidden-view');
                if (pendingCount > 0) {
                    statusText.innerText = "Aguardando Validação";
                    statusIcon.className = "w-2 h-2 rounded-full bg-yellow-400 animate-pulse";
                } else {
                    statusText.innerText = "Documentação Pendente";
                    statusIcon.className = "w-2 h-2 rounded-full bg-red-500";
                }
            }
        }

        // --- FLUXO DE MODAIS ---
        
        function openInfoModal(docLabel) {
            currentDocType = docLabel;
            document.getElementById('infoModal').classList.remove('hidden-view');
        }

        function closeInfoModal() {
            document.getElementById('infoModal').classList.add('hidden-view');
        }

        function confirmInfoAndOpenUpload() {
            closeInfoModal();
            document.getElementById('modalDocTitle').innerText = currentDocType;
            
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('uploadPreview').classList.add('hidden');
            document.getElementById('btnSendDoc').disabled = true;
            document.getElementById('btnSendDoc').innerHTML = "Enviar para Análise";
            
            document.getElementById('uploadModal').classList.remove('hidden-view');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden-view');
        }

        // --- UPLOAD E ENVIO (LOTE) ---
        function handleFileSelect(input) {
            if (input.files && input.files.length > 0) {
                const files = input.files;
                if(files[0].size > 10 * 1024 * 1024) { 
                    showToast('Um dos arquivos excede 10MB.', 'error'); 
                    input.value = ''; return; 
                }
                
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('uploadPreview').classList.remove('hidden');
                document.getElementById('uploadPreview').classList.add('flex');
                
                const count = files.length;
                const fileNameSpan = document.getElementById('fileName');
                fileNameSpan.innerText = count === 1 ? files[0].name : `${count} arquivos selecionados`;
                
                document.getElementById('btnSendDoc').disabled = false;
            }
        }

        async function submitDocumentsBatch() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            if (!files || files.length === 0) return;

            const btn = document.getElementById('btnSendDoc');
            const originalText = btn.innerHTML;
            btn.disabled = true; 
            btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div> Enviando...`;

            try {
                const uploadedFileIds = [];
                const uploadUrl = `${API_BASE_URL}/arquivos/upload`;

                // 1. Upload Individual
                for (let i = 0; i < files.length; i++) {
                    const formData = new FormData();
                    formData.append('arquivo', files[i]); 

                    console.log(`[Upload] Enviando arquivo ${i+1}/${files.length}...`);
                    const uploadRes = await fetch(uploadUrl, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    const uploadData = await uploadRes.json();
                    
                    if (!uploadRes.ok || !uploadData.success) {
                        throw new Error(`Erro no upload do arquivo ${files[i].name}`);
                    }
                    uploadedFileIds.push(uploadData.data.id);
                }

                // 2. Criar Documento(s)
                const batchPayload = {
                    arquivos: uploadedFileIds.map(id => ({
                        arquivo_id: id,
                        tipo_documento: currentDocType
                    }))
                };

                const docRes = await apiRequest('/documentos', 'POST', batchPayload);

                if (docRes.success) {
                    showToast('Documentos enviados com sucesso!', 'success');
                    closeUploadModal();
                    loadDocuments(); 
                } else { 
                    throw new Error(docRes.message); 
                }

            } catch (error) {
                console.error(error);
                showToast(error.message || 'Falha no envio', 'error');
                btn.innerHTML = originalText; 
                btn.disabled = false;
            }
        }

        function goToDashboard() {
            window.location.href = 'Sistemaprestador/boas.vindas.html';
        }

        function logout() {
            localStorage.removeItem('guardiao_token');
            localStorage.removeItem('guardiao_user');
            window.location.href = 'login_guardiao.html';
        }

        async function apiRequest(endpoint, method = 'GET', body = null) {
            if (typeof API_BASE_URL === 'undefined') throw new Error("Config API ausente.");
            const url = `${API_BASE_URL}${endpoint}`;
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            const response = await fetch(url, options);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || data.mensagem || `Erro ${response.status}`);
            }
            return data;
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const bgClass = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? '<i data-lucide="check-circle" class="w-5 h-5"></i>' : '<i data-lucide="alert-circle" class="w-5 h-5"></i>';
            
            toast.className = `fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl text-white font-semibold text-sm z-[70] transition-all duration-300 flex items-center gap-3 w-max max-w-[90%] text-center ${bgClass}`;
            toast.innerHTML = `${icon} <span>${msg}</span>`;
            lucide.createIcons();
            
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-[-20px]'), 4000);
        }
    </script>
</body>
</html>